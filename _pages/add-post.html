---
layout: none
permalink: /add-post/
sitemap: false
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <title>Add Post</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f5f5f5;
      --card: #fff;
      --border: #ddd;
      --accent: #2563eb;
      --accent-dark: #1d4ed8;
      --text: #1a1a1a;
      --muted: #666;
      --danger: #dc2626;
      --success: #16a34a;
      --radius: 10px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      padding: 16px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    h1 { font-size: 1.4rem; font-weight: 700; }

    .settings-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 1.1rem;
      cursor: pointer;
      color: var(--text);
    }

    /* Settings popover */
    .popover-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 100;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 60px 16px 0;
    }
    .popover-overlay.open { display: flex; }
    .popover {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      width: min(320px, 100%);
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    .popover h2 { font-size: 1rem; margin-bottom: 12px; }
    .popover label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 4px; }
    .popover input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.9rem;
      font-family: monospace;
      margin-bottom: 10px;
    }
    .popover .hint { font-size: 0.78rem; color: var(--muted); margin-bottom: 12px; }
    .popover-actions { display: flex; gap: 8px; }

    /* Form card */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .field { margin-bottom: 14px; }
    .field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .field input[type="text"],
    .field input[type="date"],
    .field textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 1rem;
      font-family: inherit;
      background: var(--bg);
      color: var(--text);
      transition: border-color 0.15s;
    }
    .field input:focus,
    .field textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .field textarea { min-height: 180px; resize: vertical; }

    /* File input */
    .file-label {
      display: inline-block;
      padding: 8px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      color: var(--text);
    }
    .file-name {
      display: block;
      margin-top: 6px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    /* Submit button */
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.15s;
    }
    .submit-btn:active { background: var(--accent-dark); }
    .submit-btn:disabled { background: #93c5fd; cursor: default; }

    /* Generic buttons */
    .btn {
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: opacity 0.15s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-secondary { background: none; border-color: var(--border); color: var(--text); }

    /* Status banner */
    #status {
      display: none;
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      white-space: pre-line;
    }
    #status.success { display: block; background: #dcfce7; color: var(--success); }
    #status.error   { display: block; background: #fee2e2; color: var(--danger); }
    #status.info    { display: block; background: #eff6ff; color: var(--accent); }

    /* Preview */
    #preview-block {
      display: none;
      margin-top: 14px;
    }
    #preview-block summary {
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    #preview-content {
      background: #f8f8f8;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-family: monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      word-break: break-all;
      color: var(--text);
    }
  </style>
</head>
<body>

<header>
  <h1>Add Post</h1>
  <button class="settings-btn" id="settings-open" aria-label="Settings">&#x2699;&#xFE0F;</button>
</header>

<!-- Settings popover -->
<div class="popover-overlay" id="popover-overlay">
  <div class="popover">
    <h2>Settings</h2>
    <label for="pat-input">GitHub Personal Access Token</label>
    <input type="password" id="pat-input" placeholder="github_pat_…" autocomplete="off" spellcheck="false">
    <p class="hint">
      Fine-grained: <em>Contents → Read &amp; write</em><br>
      Classic: <em>repo</em> scope<br>
      Stored in browser localStorage on this device.
    </p>
    <div class="popover-actions">
      <button class="btn btn-primary" id="pat-save">Save</button>
      <button class="btn btn-secondary" id="pat-cancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Main form -->
<div class="card">
  <form id="post-form" novalidate>

    <div class="field">
      <label for="title">Title *</label>
      <input type="text" id="title" required autocorrect="off" autocapitalize="words">
    </div>

    <div class="field">
      <label for="post-date">Date *</label>
      <input type="date" id="post-date" required>
    </div>

    <div class="field">
      <label for="excerpt">Excerpt</label>
      <input type="text" id="excerpt" placeholder="One-line teaser…" autocorrect="on" autocapitalize="sentences">
    </div>

    <div class="field">
      <label for="body">Body <span style="font-weight:400;color:var(--muted)">(Markdown)</span></label>
      <textarea id="body" placeholder="Post content… (optional if photo is provided)" autocorrect="on" autocapitalize="sentences"></textarea>
    </div>

    <div class="field">
      <label>Photo</label>
      <label class="file-label" for="photo">Choose photo…</label>
      <input type="file" id="photo" accept="image/*" style="display:none">
      <span class="file-name" id="file-name"></span>
    </div>

    <button type="submit" class="submit-btn" id="submit-btn">Add Post</button>
  </form>

  <div id="status"></div>

  <details id="preview-block">
    <summary>Preview generated file</summary>
    <pre id="preview-content"></pre>
  </details>
</div>

<script>
  // ── Helpers ────────────────────────────────────────────────────────────────

  function slugify(title) {
    return title.toLowerCase()
      .replace(/&/g, 'and')
      .replace(/['\u2018\u2019]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '');
  }

  function toBase64Unicode(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }

  function pad2(n) { return String(n).padStart(2, '0'); }

  function todayISO() {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  }

  function buildDatetime(dateStr) {
    const d = new Date();
    const [y, m, day] = dateStr.split('-');
    const dt = new Date(+y, +m - 1, +day, d.getHours(), d.getMinutes());
    const off = -dt.getTimezoneOffset();
    const sign = off >= 0 ? '+' : '-';
    const hh = pad2(Math.floor(Math.abs(off) / 60));
    const mm2 = pad2(Math.abs(off) % 60);
    return `${y}-${m}-${day}T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}:00${sign}${hh}:${mm2}`;
  }

  // ── PAT storage ────────────────────────────────────────────────────────────

  const patInput = document.getElementById('pat-input');
  const overlay  = document.getElementById('popover-overlay');

  function loadPAT() {
    patInput.value = localStorage.getItem('gh_pat') || '';
  }

  document.getElementById('settings-open').addEventListener('click', () => {
    loadPAT();
    overlay.classList.add('open');
  });
  document.getElementById('pat-cancel').addEventListener('click', () => {
    overlay.classList.remove('open');
  });
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
  document.getElementById('pat-save').addEventListener('click', () => {
    localStorage.setItem('gh_pat', patInput.value.trim());
    overlay.classList.remove('open');
  });

  // ── Default date ───────────────────────────────────────────────────────────

  document.getElementById('post-date').value = todayISO();

  // ── Photo filename display ─────────────────────────────────────────────────

  document.getElementById('photo').addEventListener('change', e => {
    const file = e.target.files[0];
    document.getElementById('file-name').textContent = file ? file.name : '';
  });

  // ── Image resize ───────────────────────────────────────────────────────────

  function loadImage(file) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
      img.onerror = reject;
      img.src = url;
    });
  }

  async function resizeImage(file) {
    const img = await loadImage(file);
    const scale = Math.min(1, 1600 / img.naturalWidth);
    const w = Math.round(img.naturalWidth * scale);
    const h = Math.round(img.naturalHeight * scale);
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
    return canvas.toDataURL('image/jpeg', 0.85);
  }

  // ── Build post content ─────────────────────────────────────────────────────

  function buildContent(fields) {
    const { title, dateStr, excerpt, body, slug, photoFilename } = fields;
    const [y, m, day] = dateStr.split('-');
    const datetime = buildDatetime(dateStr);
    const permalink = `/blog/${y}/${m}/${day}/${slug}/`;

    let fm = '---\n';
    fm += `title: "${title.replace(/"/g, '\\"')}"\n`;
    fm += `date: ${datetime}\n`;
    if (excerpt) fm += `excerpt: "${excerpt.replace(/"/g, '\\"')}"\n`;
    fm += `type: post\n`;
    fm += `permalink: ${permalink}\n`;
    fm += '---\n';

    let content = fm;
    if (body.trim()) content += '\n' + body.trim();

    if (photoFilename) {
      const imgPath = `/assets/${y}/${m}/${dateStr}-${slug}/${photoFilename}`;
      content += `\n\n![no-alignment]({{ site.url }}{{ site.baseurl }}${imgPath})`;
    }

    return content + '\n';
  }

  // ── GitHub API ─────────────────────────────────────────────────────────────

  async function githubPut(pat, path, commitMessage, base64Content) {
    const res = await fetch(
      `https://api.github.com/repos/ginn5j/ginn5j.github.io/contents/${encodeURIComponent(path).replace(/%2F/g, '/')}`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${pat}`,
          'Content-Type': 'application/json',
          'Accept': 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28'
        },
        body: JSON.stringify({ message: commitMessage, content: base64Content, branch: 'main' })
      }
    );
    return res;
  }

  // ── Submit ─────────────────────────────────────────────────────────────────

  const form           = document.getElementById('post-form');
  const submitBtn      = document.getElementById('submit-btn');
  const statusEl       = document.getElementById('status');
  const previewBlock   = document.getElementById('preview-block');
  const previewContent = document.getElementById('preview-content');

  function showStatus(type, msg) {
    statusEl.className = type;
    statusEl.textContent = msg;
  }

  async function submitPost(fields, slug, attempt) {
    const pat = localStorage.getItem('gh_pat') || '';
    if (!pat) {
      showStatus('error', 'No GitHub PAT saved. Tap ⚙ to add one.');
      return;
    }

    const { dateStr, title, photoFile } = fields;
    const [yyyy, mm] = dateStr.split('-');
    const finalSlug = attempt === 2 ? slug + '-2' : slug;

    // ── Upload photo first (if provided) ──────────────────────────────────
    let photoFilename = null;
    if (photoFile) {
      showStatus('info', 'Uploading photo…');
      const dataUrl = await resizeImage(photoFile);
      const base64 = dataUrl.replace(/^data:image\/jpeg;base64,/, '');
      const ext = photoFile.name.replace(/^.*\./, '').toLowerCase();
      photoFilename = photoFile.name.replace(/\.[^.]+$/, '.jpg');
      const photoPath = `assets/${yyyy}/${mm}/${dateStr}-${finalSlug}/${photoFilename}`;
      const photoRes = await githubPut(pat, photoPath, `Add post photo: ${title}`, base64);
      if (photoRes.status !== 201 && photoRes.status !== 200) {
        const data = await photoRes.json().catch(() => ({}));
        showStatus('error', `Photo upload error ${photoRes.status}: ${data.message || 'Unknown error'}`);
        return;
      }
    }

    // ── Upload post markdown ───────────────────────────────────────────────
    showStatus('info', photoFile ? 'Uploading photo…\nSaving post…' : 'Saving post…');

    const postFields = { ...fields, slug: finalSlug, photoFilename };
    const content = buildContent(postFields);

    previewContent.textContent = content;
    previewBlock.style.display = 'block';
    previewBlock.open = false;

    const postPath = `_posts/${yyyy}/${mm}/${dateStr}-${finalSlug}.md`;
    const postRes = await githubPut(pat, postPath, `Add post: ${title}`, toBase64Unicode(content));

    if (postRes.status === 201) {
      let successMsg = `✓ Added!\nPost: ${postPath}`;
      if (photoFilename) {
        successMsg += `\nPhoto: assets/${yyyy}/${mm}/${dateStr}-${finalSlug}/${photoFilename}`;
      }
      showStatus('success', successMsg);
      form.reset();
      document.getElementById('post-date').value = todayISO();
      document.getElementById('file-name').textContent = '';
    } else if (postRes.status === 422 && attempt === 1) {
      // File already exists — retry with -2 suffix
      await submitPost(fields, slug, 2);
    } else {
      const data = await postRes.json().catch(() => ({}));
      showStatus('error', `Error ${postRes.status}: ${data.message || 'Unknown error'}`);
    }
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();

    const title    = document.getElementById('title').value.trim();
    const dateStr  = document.getElementById('post-date').value;
    const excerpt  = document.getElementById('excerpt').value.trim();
    const body     = document.getElementById('body').value;
    const photoFile = document.getElementById('photo').files[0] || null;

    // Validation
    if (!title)   { showStatus('error', 'Title is required.'); return; }
    if (!dateStr) { showStatus('error', 'Date is required.'); return; }
    if (!body.trim() && !photoFile) {
      showStatus('error', 'Please enter body text or select a photo (or both).');
      return;
    }

    const fields = { title, dateStr, excerpt, body, photoFile };
    const slug   = slugify(title);

    statusEl.className = '';
    statusEl.textContent = '';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding…';

    try {
      await submitPost(fields, slug, 1);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Post';
    }
  });
</script>
</body>
</html>
